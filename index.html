<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem MPU3212 | BIG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: url('https://i.imgur.com/q4WcRZJ.jpeg') no-repeat center center fixed; background-size: cover; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); }
        .hidden { display: none !important; }
        .loader { border-top-color: #10b981; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn { padding-bottom: 8px; font-weight: 600; transition: all 0.3s; width: 50%; text-align: center; border-bottom: 3px solid transparent; color: #6b7280; }
        .tab-btn.active { border-color: #10b981; color: #10b981; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s; background-color: #f8fafc; }
        .drop-zone.drag-active { border-color: #10b981; background-color: #ecfdf5; transform: scale(1.02); }
        .modal-zoom { background-color: rgba(0,0,0,0.9); cursor: pointer; }
        .styled-table th { background-color: #f3f4f6; padding: 10px; font-size: 0.75rem; text-transform: uppercase; color: #374151; }
        .styled-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; font-size: 0.85rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="toast" class="fixed top-6 right-6 z-[60] hidden px-6 py-4 rounded-lg shadow-xl text-white font-bold bg-green-600 transition-all flex items-center gap-3"><i id="toast-icon" class="fas fa-check-circle"></i> <span id="toast-msg">OK</span></div>
    <div id="loader" class="fixed inset-0 bg-black/60 z-[70] hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-white h-12 w-12 mb-4"></div>
        <p class="text-white font-bold animate-pulse text-lg" id="loader-text">Memproses...</p>
    </div>
    <div id="image-modal" class="fixed inset-0 z-[80] modal-zoom hidden flex items-center justify-center p-4" onclick="document.getElementById('image-modal').classList.add('hidden')">
        <img id="modal-img-content" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl border-4 border-white">
    </div>

    <div id="view-login" class="glass w-full max-w-md p-8">
        <div class="text-center mb-8"><h1 class="text-2xl font-extrabold text-gray-800">Sistem BIG</h1><p class="text-sm text-gray-500">MPU3212</p></div>
        <div class="flex border-b mb-6"><button onclick="switchTab('student')" id="tab-student" class="tab-btn active">PELAJAR</button><button onclick="switchTab('lecturer')" id="tab-lecturer" class="tab-btn">PENSYARAH</button></div>
        <form id="form-student" onsubmit="loginStudent(event)" class="space-y-5">
            <input type="text" id="login-ic" class="w-full p-3 border rounded text-center" placeholder="No. KP" required>
            <button class="w-full bg-green-600 text-white py-3 rounded font-bold">LOG MASUK</button>
        </form>
        <form id="form-lecturer" onsubmit="loginLecturer(event)" class="space-y-5 hidden">
            <input type="email" id="login-email" class="w-full p-3 border rounded" placeholder="Emel" required>
            <input type="password" id="login-pass" class="w-full p-3 border rounded" placeholder="Kata Laluan" required>
            <button class="w-full bg-blue-600 text-white py-3 rounded font-bold">LOG MASUK STAF</button>
        </form>
    </div>

    <div id="view-student" class="glass w-full max-w-5xl p-6 hidden">
        <button onclick="location.reload()" class="absolute top-4 right-4 text-red-600 font-bold text-xs">KELUAR</button>
        <div class="flex flex-col md:flex-row gap-8 mt-6">
            <div class="md:w-1/3 flex flex-col items-center">
                <div id="drop-area" class="drop-zone w-full aspect-[3/4] rounded-xl flex items-center justify-center relative bg-white">
                    <img id="std-img" class="w-full h-full object-cover rounded-xl hidden absolute z-10" onclick="document.getElementById('modal-img-content').src=this.src;document.getElementById('image-modal').classList.remove('hidden')">
                    <div class="text-center p-4 z-0"><p class="text-xs text-gray-500 font-bold">Upload Gambar</p></div>
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept="image/*" onchange="handleFiles(this.files)">
                </div>
                <span id="img-status" class="text-[10px] font-bold text-gray-400 mt-2">Tiada gambar baru</span>
            </div>
            <div class="md:w-2/3 space-y-4">
                <h2 class="text-3xl font-bold" id="std-name">...</h2>
                <p id="std-info" class="text-sm text-gray-600"></p>
                <input type="text" id="std-alahan" class="w-full p-2 border rounded text-sm" placeholder="Alahan">
                <input type="text" id="std-ubat" class="w-full p-2 border rounded text-sm" placeholder="Ubat">
                <input type="text" id="std-tel" class="w-full p-2 border rounded text-sm" placeholder="No Waris">
                <button onclick="updateStudentData()" class="w-full bg-slate-800 text-white py-3 rounded font-bold">SIMPAN</button>
            </div>
        </div>
    </div>

    <div id="view-lecturer" class="glass w-full max-w-7xl p-6 hidden">
        <div class="flex justify-between border-b pb-4 mb-6">
            <h1 class="font-bold">Panel Penilaian <span id="lec-name" class="text-blue-600"></span></h1>
            <button onclick="location.reload()" class="text-red-600 font-bold text-xs">KELUAR</button>
        </div>
        <div class="flex mb-6 gap-2">
            <button onclick="showSection('entry')" class="px-4 py-2 bg-blue-600 text-white rounded font-bold text-xs">ISI MARKAH</button>
            <button onclick="showSection('summary')" class="px-4 py-2 bg-gray-200 text-gray-600 rounded font-bold text-xs">RUMUSAN</button>
        </div>

        <div id="sec-entry">
            <div class="flex gap-4 mb-6">
                <select id="sel-class" onchange="filterStudents()" class="p-2 border rounded text-sm w-1/2"></select>
                <select id="sel-student" onchange="previewImg()" class="p-2 border rounded text-sm w-1/2" disabled></select>
                <button onclick="loadForm()" class="bg-blue-600 text-white px-4 rounded font-bold text-xs">ISI</button>
            </div>
            <div class="flex justify-center mb-6">
                <img id="lec-view-img" class="w-32 h-40 object-cover rounded shadow hidden border bg-white" onclick="document.getElementById('modal-img-content').src=this.src;document.getElementById('image-modal').classList.remove('hidden')">
            </div>
            <div id="grading-area" class="hidden">
                <div class="flex gap-2 mb-4">
                    <button onclick="openForm('t1')" class="flex-1 bg-gray-100 py-2 rounded text-xs font-bold">T1</button>
                    <button onclick="openForm('t2')" class="flex-1 bg-gray-100 py-2 rounded text-xs font-bold">AMALI 1</button>
                    <button onclick="openForm('t3')" class="flex-1 bg-gray-100 py-2 rounded text-xs font-bold">AMALI 2</button>
                </div>
                <div id="form-t1" class="g-form hidden"><input id="t1_m1" placeholder="K1" class="border p-2 w-full mb-2"><input id="t1_m2" placeholder="K2" class="border p-2 w-full mb-2"><button onclick="save('MARKAH_TUGASAN1')" class="bg-green-600 text-white w-full py-2 rounded font-bold">SIMPAN T1</button></div>
                <div id="form-t2" class="g-form hidden"><input id="t2_m1" placeholder="Etiket" class="border p-2 w-full mb-2"><input id="t2_m2" placeholder="Guru" class="border p-2 w-full mb-2"><input id="t2_m3" placeholder="Warga" class="border p-2 w-full mb-2"><button onclick="save('MARKAH_TUGASAN2')" class="bg-green-600 text-white w-full py-2 rounded font-bold">SIMPAN T2</button></div>
                <div id="form-t3" class="g-form hidden">
                    <div class="grid grid-cols-5 gap-2 mb-2 text-center text-xs"><input id="t3_hp3_1" placeholder="Cergas"><input id="t3_hp3_2" placeholder="Makan"><input id="t3_hp3_3" placeholder="Flying"><input id="t3_hp3_4" placeholder="Tazk"><input id="t3_hp3_5" placeholder="Ref"></div>
                    <div class="grid grid-cols-4 gap-2 mb-2 text-center text-xs"><input id="t3_hp8_1" placeholder="Kem I"><input id="t3_hp8_2" placeholder="Kem K"><input id="t3_hp8_3" placeholder="Air I"><input id="t3_hp8_4" placeholder="Air K"><input id="t3_hp8_5" placeholder="Rak I"><input id="t3_hp8_6" placeholder="Rak K"><input id="t3_hp8_7" placeholder="Mkn K"></div>
                    <button onclick="save('MARKAH_TUGASAN3')" class="bg-green-600 text-white w-full py-2 rounded font-bold">SIMPAN T3</button>
                </div>
            </div>
        </div>

        <div id="sec-summary" class="hidden">
            <div class="flex gap-2 mb-4">
                <select id="sel-class-sum" class="p-2 border rounded text-sm w-1/2"></select>
                <button onclick="loadSum()" class="bg-slate-800 text-white px-4 rounded font-bold text-xs">JANA</button>
            </div>
            <div id="stats" class="flex justify-between bg-gray-100 p-4 rounded mb-4 hidden font-bold text-sm">
                <span>Mean: <span id="s-mean" class="text-blue-600"></span></span>
                <span>Std Dev: <span id="s-std" class="text-purple-600"></span></span>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-left styled-table"><thead class="bg-gray-200"><tr><th>Nama</th><th>Kelas</th><th>Total</th><th>Gred</th></tr></thead><tbody id="sum-body"></tbody></table></div>
        </div>
    </div>

    <script>
        // MASUKKAN URL ANDA DI SINI
        const APP_URL = "https://script.google.com/macros/s/AKfycbx2JQj_JX5_ERUX5zSy1MlWWf5Oz4gMaamCGAJnFQdtC0Hfz4Q12P6NxoLXYXFdp9RYEA/exec"; 

        let cache = [], curStd = null, imgData = null;
        const loader = (s) => document.getElementById('loader').classList.toggle('hidden', !s);
        const toast = (m, e) => { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText = m; 
            t.className = `fixed top-6 right-6 z-[60] px-6 py-4 rounded-lg shadow-xl text-white font-bold flex items-center gap-3 ${e ? 'bg-red-600' : 'bg-green-600'}`;
            t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); 
        };

        const switchTab = (r) => {
            document.getElementById('form-student').classList.toggle('hidden', r !== 'student');
            document.getElementById('form-lecturer').classList.toggle('hidden', r !== 'lecturer');
            document.getElementById('tab-student').className = `tab-btn ${r === 'student' ? 'active' : ''}`;
            document.getElementById('tab-lecturer').className = `tab-btn ${r === 'lecturer' ? 'active' : ''}`;
        };

        function handleFiles(f) {
            if (!f.length) return;
            loader(true);
            const r = new FileReader();
            r.onload = e => {
                const i = new Image(); i.src = e.target.result;
                i.onload = () => {
                    const c = document.createElement('canvas'), ctx = c.getContext('2d'), m = 600;
                    let w = i.width, h = i.height; if (w > m) { h *= m / w; w = m; }
                    c.width = w; c.height = h; ctx.drawImage(i, 0, 0, w, h);
                    imgData = c.toDataURL('image/jpeg', 0.6);
                    document.getElementById('std-img').src = imgData;
                    document.getElementById('std-img').classList.remove('hidden');
                    document.getElementById('img-status').innerText = "Sedia disimpan";
                    loader(false);
                }
            }; r.readAsDataURL(f[0]);
        }

        function post(d, cb) {
            loader(true);
            fetch(APP_URL, { method: "POST", body: JSON.stringify(d) })
            .then(r => r.json()).then(res => { loader(false); cb(res); })
            .catch(e => { loader(false); toast("Ralat Sambungan", true); });
        }

        function loginStudent(e) {
            e.preventDefault();
            post({ action: "login_student", no_kp: document.getElementById('login-ic').value }, r => {
                if (r.result === 'success') {
                    curStd = r.data;
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-student').classList.remove('hidden');
                    document.getElementById('std-name').innerText = curStd.nama;
                    document.getElementById('std-info').innerText = `${curStd.id} | ${curStd.kelas}`;
                    document.getElementById('std-alahan').value = curStd.alahan || "";
                    document.getElementById('std-ubat').value = curStd.ubat || "";
                    document.getElementById('std-tel').value = curStd.tel_kecemasan || "";
                    if (curStd.url_gambar) {
                        document.getElementById('std-img').src = curStd.url_gambar;
                        document.getElementById('std-img').classList.remove('hidden');
                        document.getElementById('img-status').innerText = "Profil Semasa";
                    }
                } else toast(r.message, true);
            });
        }

        function updateStudentData() {
            let d = { 
                action: "update_student_info", no_kp: curStd.no_kp, 
                alahan: document.getElementById('std-alahan').value, 
                ubat: document.getElementById('std-ubat').value, 
                tel_kecemasan: document.getElementById('std-tel').value 
            };
            if (imgData) { d.image_base64 = imgData; d.image_mime = "image/jpeg"; }
            post(d, r => { toast(r.message, r.result === 'error'); if(r.result==='success') imgData=null; });
        }

        function loginLecturer(e) {
            e.preventDefault();
            post({ action: "login_lecturer", email: document.getElementById('login-email').value, password: document.getElementById('login-pass').value }, r => {
                if (r.result === 'success') {
                    cache = r.students_list;
                    if(cache.length === 0) alert("Tiada data pelajar. Semak Sheet HELPER_LIST.");
                    document.getElementById('lec-name').innerText = r.nama;
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-lecturer').classList.remove('hidden');
                    
                    const cls = [...new Set(cache.map(s => s.kelas))].sort();
                    const s1 = document.getElementById('sel-class'), s2 = document.getElementById('sel-class-sum');
                    s1.innerHTML = s2.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                    s2.innerHTML += '<option value="SEMUA">SEMUA</option>';
                    cls.forEach(c => { s1.innerHTML += `<option>${c}</option>`; s2.innerHTML += `<option>${c}</option>`; });
                } else toast(r.message, true);
            });
        }

        function filterStudents() {
            const c = document.getElementById('sel-class').value, s = document.getElementById('sel-student');
            s.innerHTML = '<option value="">-- Pilih --</option>'; s.disabled = !c;
            document.getElementById('lec-view-img').classList.add('hidden');
            if (c) {
                const f = cache.filter(x => x.kelas === c).sort((a,b) => a.nama.localeCompare(b.nama));
                f.forEach(x => s.innerHTML += `<option value="${x.id}">${x.nama}</option>`);
            }
        }

        function previewImg() {
            const id = document.getElementById('sel-student').value, img = document.getElementById('lec-view-img');
            const st = cache.find(x => x.id == id);
            if (st && st.url_gambar) { img.src = st.url_gambar; img.classList.remove('hidden'); } else img.classList.add('hidden');
        }

        function loadForm() {
            if(!document.getElementById('sel-student').value) return toast("Pilih pelajar", true);
            document.getElementById('grading-area').classList.remove('hidden');
        }

        function openForm(id) {
            document.querySelectorAll('.g-form').forEach(e => e.classList.add('hidden'));
            document.getElementById('form-' + id).classList.remove('hidden');
        }

        function save(sn) {
            if(!confirm("Simpan?")) return;
            let d = { action: "save_mark", sheet_name: sn, student_id: document.getElementById('sel-student').value };
            if(sn.includes('1')) { d.m1 = document.getElementById('t1_m1').value; d.m2 = document.getElementById('t1_m2').value; }
            else if(sn.includes('2')) { d.m1 = document.getElementById('t2_m1').value; d.m2 = document.getElementById('t2_m2').value; d.m3 = document.getElementById('t2_m3').value; }
            else { 
                for(let i=1; i<=5; i++) d[`hp3_${i}`] = document.getElementById(`t3_hp3_${i}`).value;
                for(let i=1; i<=7; i++) d[`hp8_${i}`] = document.getElementById(`t3_hp8_${i}`).value;
            }
            post(d, r => toast(r.message, r.result === 'error'));
        }

        function loadSum() {
            const c = document.getElementById('sel-class-sum').value;
            if(!c) return toast("Pilih kelas", true);
            post({ action: "get_summary_data", kelas: c }, r => {
                if(r.result === 'success') {
                    document.getElementById('summary-stats').classList.remove('hidden');
                    document.getElementById('s-mean').innerText = r.stats.mean;
                    document.getElementById('s-std').innerText = r.stats.stdDev;
                    const b = document.getElementById('sum-body'); b.innerHTML = '';
                    r.data.forEach(d => {
                        b.innerHTML += `<tr class="border-b hover:bg-gray-50">
                            <td class="p-2 font-bold text-xs">${d.nama}</td><td class="text-xs">${d.kelas}</td>
                            <td class="p-2 text-center font-bold text-blue-600">${d.grand_total}</td>
                            <td class="p-2 text-center font-bold">${d.gred}</td>
                        </tr>`;
                    });
                }
            });
        }

        function showSection(s) {
            document.getElementById('sec-entry').classList.toggle('hidden', s !== 'entry');
            document.getElementById('sec-summary').classList.toggle('hidden', s !== 'summary');
        }
    </script>
</body>
</html>
